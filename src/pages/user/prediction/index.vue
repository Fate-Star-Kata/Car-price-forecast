<template>
  <div class="min-h-screen bg-gradient-to-br from-base-100 to-base-200">
    <!-- é¡¶éƒ¨æ¨ªå¹…åŒºåŸŸ -->
    <div class="bg-gradient-to-r from-primary/10 to-secondary/10 border-b border-base-300">
      <div class="container mx-auto px-6 py-12">
        <div class="text-center">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-primary/20 rounded-full mb-4">
            <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <h1 class="text-4xl font-bold text-base-content mb-3">æ™ºèƒ½ä»·æ ¼é¢„æµ‹</h1>
          <p class="text-lg text-base-content/70 max-w-2xl mx-auto">è¿ç”¨å…ˆè¿›çš„æœºå™¨å­¦ä¹ ç®—æ³•ï¼Œç»“åˆå¸‚åœºæ•°æ®å’Œè½¦è¾†ç‰¹å¾ï¼Œä¸ºæ‚¨æä¾›ç²¾å‡†å¯é çš„äºŒæ‰‹è½¦ä»·æ ¼è¯„ä¼°</p>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container mx-auto px-6 py-8">
      <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
        <!-- å·¦ä¾§ï¼šè½¦è¾†ä¿¡æ¯è¾“å…¥è¡¨å• -->
        <div class="xl:col-span-3">
          <div class="bg-base-100 rounded-2xl shadow-xl border border-base-300/50">
            <div class="p-8">
              <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                  </svg>
                </div>
                <h2 class="text-2xl font-bold text-base-content">è½¦è¾†ä¿¡æ¯å½•å…¥</h2>
              </div>

              <form @submit.prevent="handlePredict" class="space-y-3">
                <!-- åŸºæœ¬ä¿¡æ¯åŒºå— -->
                <div class="bg-base-50 rounded-xl p-6 border border-base-200">
                  <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-primary rounded-full"></span>
                    åŸºæœ¬ä¿¡æ¯
                  </h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-control">
                      <label class="text-lg font-bold text-base-content mb-3 block">
                        å“ç‰Œ <span class="text-red-500">*</span>
                      </label>
                      <input v-model="vehicleInfo.brand" type="text" class="input input-bordered input-lg bg-base-100 border-2 focus:border-primary" 
                             placeholder="è¯·è¾“å…¥å“ç‰Œï¼Œå¦‚ï¼šå¥¥è¿ªã€å®é©¬ã€å¥”é©°ã€å¤§ä¼—ã€ä¸°ç”°ç­‰" required>
                    </div>

                    <div class="form-control">
                      <label class="text-lg font-bold text-base-content mb-3 block">
                        è½¦å‹ <span class="text-red-500">*</span>
                      </label>
                      <input v-model="vehicleInfo.model" type="text" class="input input-bordered input-lg bg-base-100 border-2 focus:border-primary" 
                             placeholder="è¯·è¾“å…¥è½¦å‹ï¼Œå¦‚ï¼šA4ã€3ç³»ã€Cçº§ã€æœ—é€¸ã€å¡ç½—æ‹‰ç­‰" required>
                    </div>
                  </div>
                </div>

                <!-- æŠ€æœ¯å‚æ•°åŒºå— -->
                <div class="bg-base-50 rounded-xl p-6 border border-base-200">
                  <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-secondary rounded-full"></span>
                    æŠ€æœ¯å‚æ•°
                  </h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-control">
                      <label class="text-lg font-bold text-base-content mb-3 block">
                        å¹´ä»½ <span class="text-red-500">*</span>
                      </label>
                      <input v-model.number="vehicleInfo.year" type="number" class="input input-bordered input-lg bg-base-100 border-2 focus:border-primary"
                             :min="1990" :max="new Date().getFullYear()" required>
                    </div>

                    <div class="form-control">
                      <label class="text-lg font-bold text-base-content mb-3 block">
                        é‡Œç¨‹æ•° (ä¸‡å…¬é‡Œ) <span class="text-red-500">*</span>
                      </label>
                      <input v-model.number="vehicleInfo.mileage" type="number" class="input input-bordered input-lg bg-base-100 border-2 focus:border-primary"
                             min="0" step="0.1" required>
                    </div>

                    <div class="form-control">
                      <label class="text-lg font-bold text-base-content mb-3 block">
                        æ’é‡ (L) <span class="text-red-500">*</span>
                      </label>
                      <input v-model.number="vehicleInfo.displacement" type="number" class="input input-bordered input-lg bg-base-100 border-2 focus:border-primary"
                             min="0" step="0.1" required>
                    </div>
                  </div>
                </div>

                <!-- é…ç½®ä¿¡æ¯åŒºå— -->
                <div class="bg-base-50 rounded-xl p-6 border border-base-200">
                  <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-accent rounded-full"></span>
                    é…ç½®ä¿¡æ¯
                  </h3>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">


                    <div class="form-control">
                      <label class="text-lg font-bold text-base-content mb-3 block">
                        å˜é€Ÿç®±ç±»å‹ <span class="text-red-500">*</span>
                      </label>
                      <select v-model="vehicleInfo.transmission" class="select select-bordered select-lg bg-base-100 border-2 focus:border-primary" required>
                        <option value="">è¯·é€‰æ‹©å˜é€Ÿç®±ç±»å‹</option>
                        <option value="manual">æ‰‹åŠ¨</option>
                        <option value="automatic">è‡ªåŠ¨</option>
                        <option value="cvt">CVT</option>
                      </select>
                    </div>

                    <div class="form-control">
                      <label class="text-lg font-bold text-base-content mb-3 block">
                        æ‰€åœ¨åŸå¸‚ <span class="text-red-500">*</span>
                      </label>
                      <input v-model="vehicleInfo.city" type="text" class="input input-bordered input-lg bg-base-100 border-2 focus:border-primary" 
                             placeholder="è¯·è¾“å…¥åŸå¸‚ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·ã€æ·±åœ³ç­‰" required>
                    </div>
                  </div>
                </div>

                <!-- è½¦è¾†çŠ¶å†µåŒºå— -->
                <div class="bg-base-50 rounded-xl p-6 border border-base-200">
                  <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-warning rounded-full"></span>
                    è½¦è¾†çŠ¶å†µ
                  </h3>
                  <div class="form-control">
                    <label class="text-lg font-bold text-base-content mb-3 block">
                      è½¦å†µç­‰çº§ <span class="text-red-500">*</span>
                    </label>
                    <select v-model="vehicleInfo.condition" class="select select-bordered select-lg bg-base-100 border-2 focus:border-primary" required>
                      <option value="excellent">ä¼˜ç§€ - è½¦å†µæä½³ï¼Œæ— æ˜æ˜¾ç£¨æŸ</option>
                      <option value="good">è‰¯å¥½ - è½¦å†µè‰¯å¥½ï¼Œæ­£å¸¸ä½¿ç”¨ç—•è¿¹</option>
                      <option value="fair">ä¸€èˆ¬ - æœ‰ä¸€å®šç£¨æŸï¼Œä½†ä¸å½±å“ä½¿ç”¨</option>
                      <option value="poor">è¾ƒå·® - ç£¨æŸè¾ƒé‡ï¼Œéœ€è¦ç»´ä¿®</option>
                    </select>
                  </div>
                </div>

                <!-- é¢„æµ‹æŒ‰é’® -->
                <div class="flex justify-center pt-4">
                  <button type="submit" class="btn btn-primary btn-lg px-12 shadow-lg hover:shadow-xl transition-all duration-300" :disabled="isLoading">
                    <span v-if="isLoading" class="loading loading-spinner loading-md mr-2"></span>
                    <svg v-else class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    {{ isLoading ? 'æ™ºèƒ½åˆ†æä¸­...' : 'å¼€å§‹æ™ºèƒ½é¢„æµ‹' }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šé¢„æµ‹ç»“æœå’Œæ¨¡å‹é€‰æ‹© -->
        <div class="xl:col-span-1 space-y-6">
          <!-- æ¨¡å‹é€‰æ‹©å¡ç‰‡ -->
          <div class="bg-base-100 rounded-2xl shadow-xl border border-base-300/50">
            <div class="p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-secondary/10 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                  </svg>
                </div>
                <h3 class="text-xl font-bold text-base-content">AIé¢„æµ‹æ¨¡å‹</h3>
              </div>

              <div class="form-control mb-6">
                <label class="label">
                  <span class="label-text font-medium text-base-content">é€‰æ‹©é¢„æµ‹æ¨¡å‹</span>
                </label>
                <select v-model="selectedModel" class="select select-bordered select-lg bg-base-100 border-2 focus:border-secondary">
                  <option value="random_forest">ğŸ¯ éšæœºæ£®æ—æ¨¡å‹ (æ¨è)</option>
                  <option value="gradient_boosting">ğŸš€ æ¢¯åº¦æå‡æ¨¡å‹</option>
                  <option value="linear_regression">âš¡ çº¿æ€§å›å½’æ¨¡å‹</option>
                </select>
              </div>

              <div class="bg-base-50 rounded-lg p-4 space-y-2">
                <div v-if="selectedModel === 'random_forest'" class="flex items-center gap-2 mt-2">
                  <span class="text-base-content/80">éšæœºæ£®æ—ï¼šå¹³è¡¡å‡†ç¡®æ€§å’Œç¨³å®šæ€§</span>
                </div>
                <div v-else-if="selectedModel === 'gradient_boosting'" class="flex items-center gap-2 mt-2">
                  <span class="text-base-content/80">æ¢¯åº¦æå‡ï¼šé«˜ç²¾åº¦é¢„æµ‹ï¼Œè®¡ç®—æ—¶é—´è¾ƒé•¿</span>
                </div>
                <div v-else-if="selectedModel === 'linear_regression'" class="flex items-center gap-2 mt-2">
                  <span class="text-base-content/80">çº¿æ€§å›å½’ï¼šå¿«é€Ÿé¢„æµ‹ï¼Œå‡†ç¡®æ€§ç•¥ä½</span>
                </div>
              </div>
            </div>
          </div>

          <!-- é¢„æµ‹ç»“æœå¡ç‰‡ -->
          <div v-if="predictionResult" class="bg-gradient-to-br from-primary/5 to-secondary/5 rounded-2xl shadow-xl border border-primary/20">
            <div class="p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <h3 class="text-xl font-bold text-base-content">é¢„æµ‹ç»“æœ</h3>
              </div>

              <!-- ä¸»è¦ä»·æ ¼æ˜¾ç¤º -->
              <div class="text-center mb-6 p-6 bg-base-100 rounded-xl border border-primary/10">
                <div class="text-4xl font-bold text-primary mb-2">
                  Â¥{{ formatPrice(predictionResult.predicted_price) }}
                </div>
                <div class="text-sm text-base-content/70 mb-3">
                  é¢„æµ‹ä»·æ ¼èŒƒå›´
                </div>
                <div class="text-lg font-semibold text-base-content">
                  Â¥{{ formatPrice(predictionResult.price_range.min) }} - Â¥{{ formatPrice(predictionResult.price_range.max) }}
                </div>
              </div>

              <!-- ç½®ä¿¡åº¦ -->
              <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                  <span class="font-medium text-base-content">é¢„æµ‹ç½®ä¿¡åº¦</span>
                  <span class="text-lg font-bold text-primary">{{ (predictionResult.confidence * 100).toFixed(1) }}%</span>
                </div>
                <div class="relative">
                  <progress class="progress progress-primary w-full h-3" :value="predictionResult.confidence * 100" max="100"></progress>
                  <div class="absolute inset-0 flex items-center justify-center text-xs font-medium text-base-100">
                    {{ predictionResult.confidence >= 0.8 ? 'é«˜ç½®ä¿¡åº¦' : predictionResult.confidence >= 0.6 ? 'ä¸­ç­‰ç½®ä¿¡åº¦' : 'ä½ç½®ä¿¡åº¦' }}
                  </div>
                </div>
              </div>

              <!-- å½±å“å› ç´  -->
              <div>
                <h4 class="font-semibold mb-4 text-base-content">ä¸»è¦å½±å“å› ç´ </h4>
                <div class="space-y-3">
                  <div class="flex justify-between items-center p-3 bg-base-100 rounded-lg border border-base-200">
                    <span class="font-medium text-base-content">è½¦é¾„å½±å“</span>
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-bold px-2 py-1 rounded-full text-base-content bg-base-200">
                        {{ predictionResult.factor_analysis.age_impact }}%
                      </span>
                    </div>
                  </div>
                  <div class="flex justify-between items-center p-3 bg-base-100 rounded-lg border border-base-200">
                    <span class="font-medium text-base-content">é‡Œç¨‹å½±å“</span>
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-bold px-2 py-1 rounded-full text-base-content bg-base-200">
                        {{ predictionResult.factor_analysis.mileage_impact }}%
                      </span>
                    </div>
                  </div>
                  <div class="flex justify-between items-center p-3 bg-base-100 rounded-lg border border-base-200">
                    <span class="font-medium text-base-content">å“ç‰Œå½±å“</span>
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-bold px-2 py-1 rounded-full text-base-content bg-base-200">
                        {{ predictionResult.factor_analysis.brand_impact }}%
                      </span>
                    </div>
                  </div>
                  <div class="flex justify-between items-center p-3 bg-base-100 rounded-lg border border-base-200">
                    <span class="font-medium text-base-content">å…¶ä»–å½±å“</span>
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-bold px-2 py-1 rounded-full text-base-content bg-base-200">
                        {{ predictionResult.factor_analysis.other_impact }}%
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å†å²é¢„æµ‹è®°å½• -->
    <div v-if="predictionHistory.length > 0" class="mt-8">
      <div class="card bg-base-200 shadow-lg">
        <div class="card-body">
          <h3 class="card-title text-xl mb-4">å†å²é¢„æµ‹è®°å½•</h3>

          <div class="overflow-x-auto">
            <table class="table table-zebra">
              <thead>
                <tr>
                  <th>é¢„æµ‹æ—¶é—´</th>
                  <th>è½¦è¾†ä¿¡æ¯</th>
                  <th>é¢„æµ‹ä»·æ ¼</th>
                  <th>ç½®ä¿¡åº¦</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="record in predictionHistory" :key="record.id">
                  <td>{{ formatDate(record.created_at) }}</td>
                  <td>{{ record.vehicle_info.brand }} {{ record.vehicle_info.model }} ({{ record.vehicle_info.year }}å¹´)</td>
                  <td class="font-semibold text-primary">Â¥{{ formatPrice(record.predicted_price) }}</td>
                  <td>
                    <div class="badge badge-outline">{{ (record.confidence * 100).toFixed(1) }}%</div>
                  </td>
                  <td>
                    <button @click="loadHistoryRecord(record)" class="btn btn-ghost btn-xs">æŸ¥çœ‹è¯¦æƒ…</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import type { VehicleInfo, PredictionResult, PredictionHistory } from '@/types/factory'
import type { PredictionRequest, ModelSelectOption } from '@/types/apis/prediction_T'
import { predictPrice } from '@/api/user/prediction'

// å“åº”å¼æ•°æ®
const isLoading = ref(false)
const selectedModel = ref<ModelSelectOption>('random_forest')
const predictionResult = ref<PredictionResult | null>(null)
const predictionHistory = ref<PredictionHistory[]>([])

// è½¦è¾†ä¿¡æ¯è¡¨å•
const vehicleInfo = ref<VehicleInfo>({
  brand: '',
  model: '',
  year: new Date().getFullYear(),
  mileage: 0,
  displacement: 0, // æ’é‡
  transmission: '',
  condition: 'good', // é»˜è®¤è½¦å†µä¸ºgood
  city: '' // ç”¨æˆ·è¾“å…¥åŸå¸‚
})

// æ–¹æ³•
const handlePredict = async () => {
  isLoading.value = true
  try {
    // æ„å»ºAPIè¯·æ±‚å‚æ•°
    const requestData: PredictionRequest = {
      brand: vehicleInfo.value.brand,
      model: vehicleInfo.value.model,
      year: vehicleInfo.value.year,
      mileage: vehicleInfo.value.mileage,
      displacement: vehicleInfo.value.displacement,
      transmission: vehicleInfo.value.transmission,
      condition: vehicleInfo.value.condition,
      city: vehicleInfo.value.city,
      model_select: selectedModel.value
    }

    // è°ƒç”¨API
    const response = await predictPrice(requestData)
    
    if (response.code === 200) {
      // è½¬æ¢APIå“åº”ä¸ºé¡µé¢æ‰€éœ€æ ¼å¼
      predictionResult.value = {
        predicted_price: response.data.predicted_price,
        price_range: {
          min: response.data.price_range.min,
          max: response.data.price_range.max
        },
        confidence: response.data.confidence_score / 100, // è½¬æ¢ä¸º0-1èŒƒå›´
        factor_analysis: {
          age_impact: response.data.factor_analysis.age_impact,
          mileage_impact: response.data.factor_analysis.mileage_impact,
          brand_impact: response.data.factor_analysis.brand_impact,
          other_impact: response.data.factor_analysis.other_impact
        },
        model_used: response.data.model_used,
        market_insights: response.data.market_insights
      }

      // æ·»åŠ åˆ°å†å²è®°å½•
      const historyRecord: PredictionHistory = {
        id: response.data.record_id,
        vehicle_info: { ...vehicleInfo.value },
        predicted_price: response.data.predicted_price,
        confidence: response.data.confidence_score / 100,
        model_type: selectedModel.value,
        created_at: new Date().toISOString()
      }
      predictionHistory.value.unshift(historyRecord)
    } else {
      throw new Error(response.msg || 'é¢„æµ‹å¤±è´¥')
    }

  } catch (error) {
    console.error('é¢„æµ‹å¤±è´¥:', error)
    // å¯ä»¥æ·»åŠ é”™è¯¯æç¤º
    alert('é¢„æµ‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯æˆ–ç¨åé‡è¯•')
  } finally {
    isLoading.value = false
  }
}

const loadHistoryRecord = (record: PredictionHistory) => {
  vehicleInfo.value = { ...record.vehicle_info }
  predictionResult.value = {
    predicted_price: record.predicted_price,
    price_range: {
      min: record.predicted_price * 0.9,
      max: record.predicted_price * 1.1
    },
    confidence: record.confidence,
    factor_analysis: {
      age_impact: 15,
      mileage_impact: 12,
      brand_impact: 8,
      other_impact: 10
    },
    model_used: record.model_type,
    market_insights: {}
  }
}

const formatPrice = (price: number) => {
  return price.toLocaleString('zh-CN')
}

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleString('zh-CN')
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  // å¯ä»¥åœ¨è¿™é‡ŒåŠ è½½å†å²è®°å½•
})
</script>