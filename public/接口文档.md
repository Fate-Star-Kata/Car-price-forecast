# 二手车价格预测系统 API 接口文档

## 概述

本系统提供两套API接口：
- **管理员接口**：需要管理员权限，用于后台管理功能
- **普通用户接口**：需要登录认证，用于前台用户功能

## 认证方式

所有接口都需要认证，支持以下认证方式：
- Session认证
- Token认证
- Basic认证

## 响应格式

所有接口统一使用以下响应格式：

```json
{
    "code": 200,
    "msg": "success",
    "data": {}
}
```

- `code`: 状态码，200表示成功，其他表示失败
- `msg`: 响应消息
- `data`: 响应数据

---

# 管理员接口 (需要管理员权限)

## 数据集管理

### 1. 获取数据集列表

**接口地址**: `GET /car/admin/datasets`

**权限要求**: 管理员

**请求参数**:
- `query` (可选): 搜索关键词
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认10
- `dataset_type` (可选): 数据集类型 (train/test/validation/all)
- `status` (可选): 处理状态 (uploading/processing/processed/failed)

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "total": 3,
        "page": 1,
        "page_size": 10,
        "datasets": [
            {
                "id": 1,
                "name": "二手车数据集_v1.0",
                "dataset_type": "train",
                "record_count": 1000000,
                "status": "processed",
                "upload_time": "2025-09-01T10:48:12.401944",
                "created_by_name": "admin"
            },
            {
                "id": 2,
                "name": "二手车测试数据集_v1.0",
                "dataset_type": "test",
                "record_count": 200000,
                "status": "processed",
                "upload_time": "2025-09-01T10:48:12.401944",
                "created_by_name": "admin"
            },
            {
                "id": 3,
                "name": "二手车验证数据集_v1.0",
                "dataset_type": "validation",
                "record_count": 100000,
                "status": "processed",
                "upload_time": "2025-09-01T10:48:12.401944",
                "created_by_name": "admin"
            }
        ]
    }
}
```

### 2. 获取数据集详情

**接口地址**: `GET /car/admin/datasets/{dataset_id}`

**权限要求**: 管理员

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "id": 1,
        "name": "二手车数据集_v1.0",
        "description": "包含品牌、型号、年份等特征的训练数据",
        "dataset_type": "train",
        "record_count": 1000000,
        "status": "processed",
        "upload_time": "2025-09-01T10:48:12.401944",
        "created_by_name": "admin"
    }
}
```

### 3. 删除数据集

**接口地址**: `POST /car/admin/datasets/delete`

**权限要求**: 管理员

**请求参数**:
```json
{
    "dataset_id": 1
}
```

### 4. 获取数据集统计

**接口地址**: `GET /car/admin/datasets/stats`

**权限要求**: 管理员

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "total_datasets": 3,
        "train_datasets": 1,
        "test_datasets": 1,
        "total_records": 1300000,
        "data_quality": 66.7
    }
}
```

## 模型管理

### 1. 获取模型列表

**接口地址**: `GET /car/admin/models`

**权限要求**: 管理员

**请求参数**:
- `query` (可选): 搜索关键词
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认10
- `algorithm_type` (可选): 算法类型
- `status` (可选): 模型状态

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "total": 3,
        "page": 1,
        "page_size": 10,
        "models": [
            {
                "id": 1,
                "name": "随机森林模型_v2.1",
                "algorithm_type": "random_forest",
                "algorithm_type_display": "Random Forest",
                "status": "production",
                "status_display": "生产中",
                "accuracy": 0.958,
                "training_dataset": 1,
                "training_dataset_name": "二手车数据集_v1.0",
                "created_by": 1,
                "created_by_name": "admin",
                "training_start_time": "2025-09-01T10:48:12.401944",
                "training_end_time": null,
                "model_path": null,
                "parameters": {
                    "n_estimators": 100,
                    "max_depth": 10
                },
                "metrics": {
                    "mse": 0.042,
                    "r2": 0.958
                }
            }
        ]
    }
}
```

### 2. 获取模型详情

**接口地址**: `GET /car/admin/models/{model_id}`

**权限要求**: 管理员

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "id": 1,
        "name": "随机森林模型_v2.1",
        "algorithm_type": "random_forest",
        "algorithm_type_display": "Random Forest",
        "status": "production",
        "status_display": "生产中",
        "accuracy": 0.958,
        "training_dataset": 1,
        "training_dataset_name": "二手车数据集_v1.0",
        "created_by": 1,
        "created_by_name": "admin",
        "training_start_time": "2025-09-01T10:48:12.401944",
        "training_end_time": null,
        "model_path": null,
        "parameters": {
            "n_estimators": 100,
            "max_depth": 10
        },
        "metrics": {
            "mse": 0.042,
            "r2": 0.958
        }
    }
}
```

### 3. 修改模型状态

**接口地址**: `POST /car/admin/models/status`

**权限要求**: 管理员

**请求参数**:
```json
{
    "model_id": 1,
    "status": "production"
}
```

**状态说明**:
- `training`: 训练中
- `completed`: 训练完成
- `production`: 生产中
- `stopped`: 已停用
- `failed`: 训练失败

### 4. 删除模型

**接口地址**: `POST /car/admin/models/delete`

**权限要求**: 管理员

**请求参数**:
```json
{
    "model_id": 1
}
```

### 5. 获取模型统计

**接口地址**: `GET /car/admin/models/stats`

**权限要求**: 管理员

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "total_models": 3,
        "production_models": 1,
        "best_accuracy": 95.8,
        "avg_response_time": 2.3
    }
}
```

## 预测记录管理

### 1. 获取预测记录列表

**接口地址**: `GET /car/admin/predictions`

**权限要求**: 管理员

**请求参数**:
- `query` (可选): 搜索用户名
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认10
- `user_id` (可选): 用户ID
- `model_id` (可选): 模型ID

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "total": 2,
        "page": 1,
        "page_size": 10,
        "predictions": [
            {
                "id": 1,
                "user_name": "testuser",
                "model_name": "随机森林模型_v2.1",
                "input_data": {
                    "brand": "丰田",
                    "model": "凯美瑞",
                    "year": 2018,
                    "mileage": 50000
                },
                "predicted_price": 125000.50,
                "confidence_score": 0.892,
                "prediction_time": "2025-09-01T14:30:15.123456"
            },
            {
                "id": 2,
                "user_name": "admin",
                "model_name": "随机森林模型_v2.1",
                "input_data": {
                    "brand": "本田",
                    "model": "雅阁",
                    "year": 2019,
                    "mileage": 30000
                },
                "predicted_price": 145000.75,
                "confidence_score": 0.915,
                "prediction_time": "2025-09-01T15:45:22.654321"
            }
        ]
    }
}
```

---

# 普通用户接口 (需要登录认证)

## 公开数据集接口

### 1. 获取公开数据集列表

**接口地址**: `GET /car/datasets`

**权限要求**: 登录用户

**说明**: 只显示状态为 `processed` 的数据集

**请求参数**:
- `query` (可选): 搜索关键词
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认10
- `dataset_type` (可选): 数据集类型

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "total": 2,
        "page": 1,
        "page_size": 10,
        "datasets": [
            {
                "id": 1,
                "name": "二手车数据集_v1.0",
                "dataset_type": "train",
                "record_count": 1000000,
                "status": "processed",
                "description": "包含品牌、型号、年份等特征的训练数据"
            },
            {
                "id": 2,
                "name": "二手车测试数据集_v1.0",
                "dataset_type": "test",
                "record_count": 200000,
                "status": "processed",
                "description": "用于模型测试的数据集"
            }
        ]
    }
}
```

### 2. 获取公开数据集详情

**接口地址**: `GET /car/datasets/{dataset_id}`

**权限要求**: 登录用户

**说明**: 只能查看状态为 `processed` 的数据集

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "id": 1,
        "name": "二手车数据集_v1.0",
        "description": "包含品牌、型号、年份等特征的训练数据",
        "dataset_type": "train",
        "record_count": 1000000,
        "status": "processed"
    }
}
```

## 公开模型接口

### 1. 获取公开模型列表

**接口地址**: `GET /car/models`

**权限要求**: 登录用户

**说明**: 只显示状态为 `production` 或 `completed` 的模型

**请求参数**:
- `query` (可选): 搜索关键词
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认10
- `algorithm_type` (可选): 算法类型

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "total": 1,
        "page": 1,
        "page_size": 10,
        "models": [
            {
                "id": 1,
                "created_by_name": "admin",
                "algorithm_type_display": "Random Forest",
                "status_display": "生产中",
                "training_dataset_name": "二手车数据集_v1.0",
                "name": "随机森林模型_v2.1",
                "algorithm_type": "random_forest",
                "accuracy": 0.958,
                "status": "production",
                "training_start_time": "2025-09-01T10:48:12.401944",
                "training_end_time": null,
                "model_path": null,
                "parameters": {
                    "n_estimators": 100,
                    "max_depth": 10
                },
                "metrics": {
                    "mse": 0.042,
                    "r2": 0.958
                },
                "training_dataset": 1,
                "created_by": 1
            }
        ]
    }
}
```

### 2. 获取公开模型详情

**接口地址**: `GET /car/models/{model_id}`

**权限要求**: 登录用户

**说明**: 只能查看状态为 `production` 或 `completed` 的模型

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "id": 1,
        "created_by_name": "admin",
        "algorithm_type_display": "Random Forest",
        "status_display": "生产中",
        "training_dataset_name": "二手车数据集_v1.0",
        "name": "随机森林模型_v2.1",
        "algorithm_type": "random_forest",
        "accuracy": 0.958,
        "status": "production",
        "training_start_time": "2025-09-01T10:48:12.401944",
        "training_end_time": null,
        "model_path": null,
        "parameters": {
            "n_estimators": 100,
            "max_depth": 10
        },
        "metrics": {
            "mse": 0.042,
            "r2": 0.958
        },
        "training_dataset": 1,
        "created_by": 1
    }
}
```

## 用户预测记录

### 1. 获取我的预测记录

**接口地址**: `GET /car/my-predictions`

**权限要求**: 登录用户

**说明**: 只显示当前用户的预测记录

**请求参数**:
- `page` (可选): 页码，默认1
- `page_size` (可选): 每页数量，默认10
- `model_id` (可选): 模型ID

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "total": 0,
        "page": 1,
        "page_size": 10,
        "records": []
    }
}
```

## 公开统计信息

### 1. 获取系统统计

**接口地址**: `GET /car/stats`

**权限要求**: 登录用户

**响应示例**:
```json
{
    "code": 200,
    "msg": null,
    "data": {
        "total_datasets": 2,
        "total_models": 1,
        "production_models": 1,
        "total_predictions": 2,
        "best_accuracy": 95.8,
        "user_predictions": 0
    }
}
```

## 模型训练

### 1. 提交训练任务

**接口地址**: `POST /car/training`

**权限要求**: 登录用户

**请求参数**:
```json
{
    "name": "我的随机森林模型",
    "algorithm_type": "random_forest",
    "training_dataset_id": 1,
    "parameters": {
        "n_estimators": 100,
        "max_depth": 10,
        "learning_rate": 0.01
    }
}
```

**算法类型**:
- `random_forest`: 随机森林
- `gradient_boosting`: 梯度提升
- `neural_network`: 神经网络
- `linear_regression`: 线性回归
- `svm`: 支持向量机

**响应示例**:
```json
{
    "code": 201,
    "msg": "请填写完整的训练参数",
    "data": null
}
```

**注意**: 当前接口返回错误，可能需要提供更完整的训练参数。

## 价格预测

### 1. 预测车辆价格

**接口地址**: `POST /car/prediction`

**权限要求**: 登录用户

**请求参数**:
```json
{
    "model_id": 1,
    "input_data": {
        "brand": "toyota",
        "model": "camry",
        "year": 2020,
        "mileage": 3.5,
        "displacement": 2.0,
        "transmission": "automatic",
        "fuel_type": "gasoline",
        "condition": "good"
    }
}
```

**响应示例**:
```json
{
    "code": 201,
    "msg": "请提供模型ID和输入数据",
    "data": null
}
```

**注意**: 当前接口返回错误，可能需要调整请求参数格式或数据结构。

---

# 错误码说明

| 错误码 | 说明           |
| ------ | -------------- |
| 200    | 成功           |
| 400    | 请求参数错误   |
| 401    | 未认证         |
| 403    | 权限不足       |
| 404    | 资源不存在     |
| 500    | 服务器内部错误 |

# 使用示例

## Python 示例

```python
import requests

# 登录获取认证
login_data = {
    'username': 'your_username',
    'password': 'your_password'
}
response = requests.post('http://localhost:8000/login/', data=login_data)
session = requests.Session()
session.cookies.update(response.cookies)

# 获取公开模型列表
response = session.get('http://localhost:8000/car/models/')
models = response.json()

# 提交预测请求
prediction_data = {
    'model_id': 1,
    'input_data': {
        'brand': 'toyota',
        'model': 'camry',
        'year': 2020,
        'mileage': 3.5,
        'displacement': 2.0,
        'transmission': 'automatic',
        'fuel_type': 'gasoline',
        'condition': 'good'
    }
}
response = session.post('http://localhost:8000/car/prediction/', json=prediction_data)
result = response.json()
print(f"预测价格: {result['data']['predicted_price']}")
```

## JavaScript 示例

```javascript
// 获取公开统计信息
fetch('/car/stats/', {
    method: 'GET',
    credentials: 'include',
    headers: {
        'Content-Type': 'application/json',
    }
})
.then(response => response.json())
.then(data => {
    console.log('系统统计:', data.data);
});

// 提交预测请求
fetch('/car/prediction/', {
    method: 'POST',
    credentials: 'include',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
        model_id: 1,
        input_data: {
            brand: 'toyota',
            model: 'camry',
            year: 2020,
            mileage: 3.5,
            displacement: 2.0,
            transmission: 'automatic',
            fuel_type: 'gasoline',
            condition: 'good'
        }
    })
})
.then(response => response.json())
.then(data => {
    console.log('预测结果:', data.data);
});
```

---

# 注意事项

1. **权限控制**: 管理员接口需要管理员权限，普通用户接口需要登录认证
2. **数据过滤**: 普通用户只能访问公开的数据集和模型
3. **个人数据**: 用户只能查看自己的预测记录
4. **模型训练**: 训练任务是异步处理，需要轮询状态
5. **预测服务**: 目前返回模拟数据，实际部署需要集成机器学习服务
6. **文件上传**: 数据集上传功能需要额外的文件处理接口
7. **缓存**: 建议对统计接口进行缓存优化
8. **限流**: 生产环境建议对预测接口进行限流控制

# 更新日志

- **v1.0.0** (2024-01-15): 初始版本，包含基础的数据集、模型和预测功能
- **v1.1.0** (当前): 区分管理员和普通用户权限，增加公开接口